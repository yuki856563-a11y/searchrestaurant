<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‰¾åº—ç¥å™¨ - æœæœé¤å»³</title>
    
    <!-- PWA èˆ‡æ‰‹æ©Ÿå°ˆå±¬è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/restaurant.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'soso-eat-app';

        window.dbTools = { 
            db, auth, appId, collection, doc, setDoc, deleteDoc, onSnapshot, query,
            signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --brand-orange: #FF6B35;
            --brand-peach: #FFF5F1;
            --glass-bg: rgba(255, 255, 255, 0.82);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFDFD;
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 107, 53, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 107, 53, 0.03) 0px, transparent 50%);
            overscroll-behavior-y: contain;
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
        }

        /* è¨­è¨ˆæ„ŸèƒŒæ™¯çƒ */
        .bg-blob {
            position: fixed;
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 159, 124, 0.05) 100%);
            filter: blur(80px);
            border-radius: 50%;
            z-index: -1;
            pointer-events: none;
        }

        /* å¢å¼·é™°å½±çš„å°èˆªåˆ— */
        .glass-nav {
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            /* å¤šé‡é™°å½±ç‡Ÿé€ æ·±åº¦æ„Ÿ */
            box-shadow: 
                0 4px 20px -5px rgba(0, 0, 0, 0.03),
                0 15px 35px -10px rgba(255, 107, 53, 0.05);
        }

        .tap-scale:active { transform: scale(0.96); }
        
        /* é¤å»³å¡ç‰‡é™°å½± */
        .card-shadow {
            box-shadow: 0 10px 40px -10px rgba(255, 107, 53, 0.08), 0 5px 15px -5px rgba(0, 0, 0, 0.03);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #f9f9f9 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .tab-active { color: var(--brand-orange); }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--brand-orange);
        }

        /* åœ°åœ–è¨­è¨ˆæ„Ÿå„ªåŒ– */
        #taiwan-map path {
            fill: #E9EEF2;
            stroke: #FFFFFF;
            stroke-width: 1.2;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
        }
        #taiwan-map path.has-store { fill: #FFE5D9; stroke: #FFB38E; }
        #taiwan-map path.active-city { fill: #FF6B35 !important; stroke: #EA580C; filter: drop-shadow(0 4px 6px rgba(255, 107, 53, 0.2)); }
        #taiwan-map path:hover { fill: #FFD2BC; }

        .drawer-up {
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .drawer-up.open { transform: translateY(0); }

        .city-tab-item { transition: all 0.2s ease; }
    </style>
</head>
<body class="flex flex-col min-h-screen select-none overflow-x-hidden">

    <!-- èƒŒæ™¯è£é£¾çƒ -->
    <div class="bg-blob" style="top: -50px; left: -50px;"></div>
    <div class="bg-blob" style="bottom: 100px; right: -100px; width: 400px; height: 400px; opacity: 0.6;"></div>

    <!-- é ‚éƒ¨æ™ºæ…§æœå°‹å€ -->
    <header id="main-header" class="glass-nav sticky top-0 z-50 px-6 pt-14 pb-5">
        <div class="max-w-md mx-auto">
            <div class="flex items-center justify-between mb-5">
                <div class="flex items-center gap-2">
                    <div class="w-9 h-9 bg-orange-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-orange-200 ring-2 ring-white/50">
                        <i data-lucide="utensils" class="w-5 h-5"></i>
                    </div>
                    <h1 class="text-2xl font-black text-gray-900 tracking-tight">æœæœé¤å»³<span class="text-orange-500">.</span></h1>
                </div>
                <div class="bg-orange-100/40 backdrop-blur-md px-3 py-1 rounded-full text-orange-600 border border-orange-200/40">
                    <i data-lucide="sparkles" class="w-3.5 h-3.5 inline-block -mt-0.5 mr-1"></i>
                    <span class="text-[9px] font-black uppercase tracking-widest">Premium AI</span>
                </div>
            </div>
            
            <div class="relative flex flex-col gap-2">
                <div class="relative flex items-center gap-2">
                    <!-- åŠ å¼·é™°å½±çš„è¼¸å…¥å€åŸŸå®¹å™¨ -->
                    <div class="relative flex-grow group">
                        <i data-lucide="link-2" class="absolute left-4 top-4 text-gray-300 group-focus-within:text-orange-400 w-4 h-4 transition-colors"></i>
                        <input type="text" id="aiInput" 
                            placeholder="è²¼ä¸Šç¶²å€ã€åº—åæˆ–ç¤¾ç¾¤é€£çµ..." 
                            class="w-full bg-white/70 border border-white/50 rounded-2xl py-4 pl-11 pr-12 text-sm focus:ring-4 focus:ring-orange-500/10 focus:bg-white outline-none transition-all placeholder-gray-400 shadow-xl shadow-orange-950/5">
                        
                        <button onclick="triggerImageUpload()" class="absolute right-3.5 top-3.5 p-1 text-gray-400 hover:text-orange-500 transition-colors tap-scale">
                            <i data-lucide="camera" class="w-6 h-6"></i>
                        </button>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="processImageWithAI(event)">
                    </div>
                    <button onclick="processWithAI()" class="bg-gray-900 text-white px-6 py-4 rounded-2xl font-bold text-sm tap-scale shadow-2xl shadow-gray-300 hover:bg-black transition-all">
                        æ”¶è—
                    </button>
                </div>
                <div class="px-2">
                    <div class="h-0.5 w-8 bg-orange-100 rounded-full mb-1"></div>
                    <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest opacity-60">Ready to Discover</p>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-grow pb-24 overflow-x-hidden relative">
        
        <!-- [æ¢ç´¢åˆ†é ] -->
        <div id="page-home" class="page-content">
            <section class="mt-6">
                <div id="city-tabs" class="flex gap-4 overflow-x-auto no-scrollbar px-6 pb-4">
                    <button onclick="filterByCity('å…¨éƒ¨')" class="city-tab-item relative whitespace-nowrap text-[10px] font-black uppercase tracking-widest text-gray-900 tab-active pb-1">All Stores</button>
                </div>
            </section>
            
            <section class="px-6 mt-2 max-w-md mx-auto">
                <div id="loading-skeleton" class="hidden space-y-5">
                    <div class="h-48 w-full loading-shimmer rounded-[3rem]"></div>
                </div>
                <div id="empty-state" class="flex flex-col items-center justify-center py-24 text-center">
                    <div class="w-20 h-20 bg-white rounded-3xl shadow-sm border border-gray-100 flex items-center justify-center mb-6">
                        <i data-lucide="map-pin" class="w-10 h-10 text-orange-200"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium leading-relaxed">ç›®å‰é‚„æ²’æœ‰æ”¶è—<br><span class="text-xs opacity-60">è©¦è‘—è²¼ä¸Š IG é€£çµæˆ–æˆªåœ–å§ï¼</span></p>
                </div>
                <div id="restaurant-grid" class="grid grid-cols-1 gap-6 pb-10"></div>
            </section>
        </div>

        <!-- [åœ°åœ–/åŸå¸‚åˆ†é ] -->
        <div id="page-cities" class="page-content hidden px-6 pt-10">
            <div class="max-w-md mx-auto text-center">
                <div class="inline-block px-3 py-1 bg-white rounded-full border border-gray-100 text-[10px] font-black text-orange-500 uppercase tracking-[0.2em] mb-4">Discovery Map</div>
                <h2 class="text-2xl font-black text-gray-900 mb-2">åŸå¸‚æ¢ç´¢åœ°åœ–</h2>
                <p class="text-xs text-gray-400 mb-10 font-medium">é»æ“Šç¸£å¸‚å³å¯è‡ªå‹•æ™ºæœåœ¨åœ°ç¾é£Ÿ</p>
                
                <div class="relative bg-white/40 backdrop-blur-sm rounded-[3rem] p-8 border border-white/60 shadow-inner mb-10">
                    <div class="absolute -z-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-orange-100/30 blur-[60px] rounded-full"></div>
                    <svg id="taiwan-map" viewBox="0 0 595.28 841.89" class="w-full h-auto max-w-[280px] mx-auto filter drop-shadow-2xl">
                        <!-- ç¸£å¸‚è·¯å¾‘ -->
                        <path id="åŸºéš†å¸‚" d="M428.5,47.5l-2.8,4.2l5.7,2.8l1.4-4.2L428.5,47.5z" />
                        <path id="å°åŒ—å¸‚" d="M410.5,60.5l-10,15.7l14.3,11.4l11.4-18.6L410.5,60.5z" />
                        <path id="æ–°åŒ—å¸‚" d="M380.5,40.5l-5.7,28.6l31.4,45.7l40-20l-14.3-48.6L380.5,40.5z" />
                        <path id="æ¡ƒåœ’å¸‚" d="M330.5,90.5l-11.4,40l45.7,11.4l15.7-34.3L330.5,90.5z" />
                        <path id="æ–°ç«¹å¸‚" d="M300.5,140.5l-5.7,11.4l11.4,5.7l5.7-11.4L300.5,140.5z" />
                        <path id="æ–°ç«¹ç¸£" d="M310.5,150.5l-11.4,34.3l34.3,11.4l11.4-34.3L310.5,150.5z" />
                        <path id="è‹—æ —ç¸£" d="M270.5,180.5l-22.8,51.4l45.7,17.1l22.8-51.4L270.5,180.5z" />
                        <path id="å°ä¸­å¸‚" d="M220.5,250.5l-28.6,57.1l80,28.6l28.6-62.8L220.5,250.5z" />
                        <path id="å½°åŒ–ç¸£" d="M170.5,320.5l-17.1,45.7l45.7,11.4l17.1-45.7L170.5,320.5z" />
                        <path id="å—æŠ•ç¸£" d="M250.5,320.5l-17.1,100l74.3,28.6l34.3-105.7L250.5,320.5z" />
                        <path id="é›²æ—ç¸£" d="M140.5,380.5l-11.4,45.7l45.7,11.4l11.4-45.7L140.5,380.5z" />
                        <path id="å˜‰ç¾©å¸‚" d="M150.5,440.5l-5.7,11.4l11.4,5.7l5.7-11.4L150.5,440.5z" />
                        <path id="å˜‰ç¾©ç¸£" d="M160.5,450.5l-22.8,45.7l57.1,22.8l22.8-51.4L160.5,450.5z" />
                        <path id="å°å—å¸‚" d="M110.5,520.5l-17.1,80l80,22.8l17.1-85.7L110.5,520.5z" />
                        <path id="é«˜é›„å¸‚" d="M150.5,620.5l-28.6,120l62.8,17.1l45.7-114.3L150.5,620.5z" />
                        <path id="å±æ±ç¸£" d="M170.5,750.5l-11.4,85.7l57.1-22.8l17.1-62.8L170.5,750.5z" />
                        <path id="å®œè˜­ç¸£" d="M400.5,120.5l-28.6,85.7l57.1,17.1l45.7-80L400.5,120.5z" />
                        <path id="èŠ±è“®ç¸£" d="M350.5,250.5l-45.7,245.7l62.8,28.6l57.1-240L350.5,250.5z" />
                        <path id="å°æ±ç¸£" d="M280.5,550.5l-45.7,211.4l74.3,11.4l45.7-194.3L280.5,550.5z" />
                        <path id="æ¾æ¹–ç¸£" d="M40.5,400.5l-5.7,11.4l11.4,5.7l5.7-11.4L40.5,400.5z" />
                    </svg>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/80 p-5 rounded-[2.5rem] card-shadow border border-white flex flex-col items-center">
                        <span class="text-gray-900 font-black text-2xl" id="stat-count">0</span>
                        <span class="text-[9px] text-gray-400 font-black uppercase mt-1 tracking-widest">Bookmarks</span>
                    </div>
                    <div class="bg-white/80 p-5 rounded-[2.5rem] card-shadow border border-white flex flex-col items-center">
                        <span class="text-orange-500 font-black text-2xl" id="stat-city">0</span>
                        <span class="text-[9px] text-gray-400 font-black uppercase mt-1 tracking-widest">Cities</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- [å€‹äººåˆ†é ] -->
        <div id="page-profile" class="page-content hidden px-6 pt-20">
            <div class="max-w-md mx-auto text-center">
                 <div class="w-24 h-24 bg-gradient-to-tr from-orange-500 to-orange-300 rounded-[2.5rem] mx-auto mb-6 flex items-center justify-center text-white shadow-xl shadow-orange-100">
                     <i data-lucide="user" class="w-12 h-12"></i>
                 </div>
                 <h2 class="text-2xl font-black text-gray-900">ç¾é£Ÿæ¢ç´¢å®¶</h2>
                 <p class="text-sm text-gray-400 mt-3 font-medium leading-relaxed px-10">
                     ç¹¼çºŒæ”¶è—æ‚¨çš„åŸå¸‚é©šå–œï¼Œ<br>
                     å»ºç«‹å°ˆå±¬æ–¼æ‚¨çš„ç§è—åœ°åœ–ã€‚
                 </p>
                 <div class="mt-12 bg-white rounded-[2.5rem] p-8 border border-gray-50 card-shadow">
                     <div class="flex items-center justify-between mb-4">
                         <span class="text-xs font-bold text-gray-400">ç•¶å‰ç‰ˆæœ¬</span>
                         <span class="text-xs font-black text-gray-900 tracking-tighter">v2.5 Premium</span>
                     </div>
                     <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                         <div class="w-1/3 h-full bg-orange-500"></div>
                     </div>
                 </div>
            </div>
        </div>
    </main>

    <!-- åŸå¸‚æ¢ç´¢æŠ½å±œ -->
    <div id="city-drawer" class="fixed inset-0 bg-gray-900/40 z-[100] hidden opacity-0 transition-opacity backdrop-blur-sm">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[3.5rem] p-8 pb-12 h-[82vh] overflow-y-auto drawer-up no-scrollbar shadow-2xl border-t border-white/50">
            <div class="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-8"></div>
            
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h2 id="drawer-city-name" class="text-3xl font-black text-gray-900 tracking-tight">ç¸£å¸‚åç¨±</h2>
                    <p class="text-[10px] text-orange-500 font-black mt-1 uppercase tracking-[0.2em]">Smart Discovery Engine</p>
                </div>
                <button onclick="closeCityDrawer()" class="bg-gray-50 p-3 rounded-full text-gray-400 tap-scale">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-10">
                <button onclick="discoverFood('high-rated')" class="bg-orange-600 text-white p-5 rounded-[2.5rem] tap-scale flex flex-col items-center gap-2 shadow-lg shadow-orange-100">
                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                    <span class="text-[10px] font-black uppercase">High Rated</span>
                </button>
                <button onclick="discoverFood('local')" class="bg-gray-900 text-white p-5 rounded-[2.5rem] tap-scale flex flex-col items-center gap-2 shadow-lg shadow-gray-200">
                    <i data-lucide="utensils" class="w-6 h-6"></i>
                    <span class="text-[10px] font-black uppercase">Local Eats</span>
                </button>
            </div>

            <div id="discovery-results" class="space-y-5 pb-10">
                <div class="text-center py-20 text-gray-300">
                    <i data-lucide="search" class="w-12 h-12 mx-auto mb-4 opacity-10"></i>
                    <p class="text-sm font-bold opacity-30 tracking-tight">æƒ³è¦æ¢ç´¢ä»€éº¼æ¨£çš„ç¾é£Ÿï¼Ÿ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav class="glass-nav fixed bottom-0 left-0 right-0 border-t border-white/50 px-8 pt-4 pb-8 flex justify-around items-center z-50 rounded-t-[2.5rem] shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
        <button onclick="switchTab('home')" id="tab-home" class="flex flex-col items-center gap-1.5 tap-scale text-orange-500 transition-all">
            <i data-lucide="compass" class="w-6 h-6"></i>
            <span class="text-[9px] font-black uppercase tracking-widest">Explore</span>
        </button>
        <button onclick="switchTab('cities')" id="tab-cities" class="flex flex-col items-center gap-1.5 tap-scale text-gray-300 transition-all">
            <i data-lucide="map" class="w-6 h-6"></i>
            <span class="text-[9px] font-black uppercase tracking-widest">Cities</span>
        </button>
        <button onclick="switchTab('profile')" id="tab-profile" class="flex flex-col items-center gap-1.5 tap-scale text-gray-300 transition-all">
            <i data-lucide="user" class="w-6 h-6"></i>
            <span class="text-[9px] font-black uppercase tracking-widest">Me</span>
        </button>
    </nav>

    <!-- åå¸è¨Šæ¯ -->
    <div id="toast" class="fixed bottom-32 left-1/2 -translate-x-1/2 bg-gray-900/95 backdrop-blur-md text-white px-6 py-3.5 rounded-2xl text-[10px] font-black tracking-widest uppercase shadow-2xl z-[150] opacity-0 pointer-events-none transition-all duration-300">
        Success!
    </div>

    <script>
        let allRestaurants = [];
        let currentCityFilter = "å…¨éƒ¨";
        let activeDrawerCity = "";
        const apiKey = ""; 

        async function init() {
            lucide.createIcons();
            initMapEvents();
            
            const checkFirebase = setInterval(async () => {
                if (window.dbTools) {
                    clearInterval(checkFirebase);
                    const { auth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.dbTools;
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) listenData(user.uid);
                    });
                }
            }, 100);
        }

        function listenData(uid) {
            const { db, appId, onSnapshot, collection } = window.dbTools;
            const colRef = collection(db, 'artifacts', appId, 'users', uid, 'restaurants');
            onSnapshot(colRef, (snapshot) => {
                allRestaurants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.createdAt - a.createdAt);
                updateUI();
                updateMapData();
            });
        }

        function initMapEvents() {
            const map = document.getElementById('taiwan-map');
            map.addEventListener('click', (e) => {
                const city = e.target.id;
                if (city) openCityDrawer(city);
            });
        }

        function openCityDrawer(city) {
            activeDrawerCity = city;
            document.getElementById('drawer-city-name').innerText = city;
            document.getElementById('discovery-results').innerHTML = `
                <div class="text-center py-24 text-gray-300">
                    <i data-lucide="search" class="w-12 h-12 mx-auto mb-4 opacity-10"></i>
                    <p class="text-sm font-bold opacity-30 tracking-tight">è®“ AI åœ¨ ${city} å¹«æ‚¨æ‰¾ç¾é£Ÿ...</p>
                </div>
            `;
            const drawer = document.getElementById('city-drawer');
            drawer.classList.remove('hidden');
            setTimeout(() => {
                drawer.classList.add('opacity-100');
                drawer.querySelector('.drawer-up').classList.add('open');
            }, 10);
            lucide.createIcons();
        }

        function closeCityDrawer() {
            const drawer = document.getElementById('city-drawer');
            drawer.querySelector('.drawer-up').classList.remove('open');
            drawer.classList.remove('opacity-100');
            setTimeout(() => drawer.classList.add('hidden'), 500);
        }

        async function discoverFood(type) {
            const container = document.getElementById('discovery-results');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 space-y-6">
                    <div class="relative">
                        <div class="w-12 h-12 border-4 border-orange-100 border-t-orange-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">AI Intelligence Searching...</p>
                </div>
            `;
            lucide.createIcons();

            const query = type === 'high-rated' 
                ? `æ‰¾å°‹ ${activeDrawerCity} è©•åˆ†æœ€é«˜(4.5åˆ†ä»¥ä¸Š)çš„å‰äº”åé¤å»³ã€‚`
                : `æ‰¾å°‹ ${activeDrawerCity} éš±è—ç‰ˆå°åƒã€è€åº—ã€æ”¤è²©ã€‚`;

            const systemPrompt = `å›å‚³ JSON é™£åˆ—ï¼š[{"name": "...", "city": "${activeDrawerCity}", "category": "...", "rating": 4.5, "summary": "...", "tags": ["..."]}]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: query }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        tools: [{ "google_search": {} }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const result = await response.json();
                const list = JSON.parse(result.candidates[0].content.parts[0].text);
                renderDiscoveryList(list);
            } catch (err) {
                container.innerHTML = `<p class="text-center py-10 text-xs text-red-400 font-bold uppercase tracking-widest">Search Failed</p>`;
            }
        }

        function renderDiscoveryList(list) {
            const container = document.getElementById('discovery-results');
            container.innerHTML = list.map(item => `
                <div class="bg-gray-50/80 rounded-[2.5rem] p-6 border border-white relative tap-scale transition-all">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-black text-gray-900 tracking-tight">${item.name}</h3>
                        <div class="flex items-center gap-1 text-orange-500 text-[10px] font-black bg-orange-50 px-2 py-1 rounded-lg">
                            <i data-lucide="star" class="w-3 h-3 fill-orange-500"></i> ${item.rating}
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 leading-relaxed mb-5 font-medium">${item.summary}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex gap-2">
                            ${item.tags.slice(0,2).map(t => `<span class="text-[9px] font-bold text-gray-400">#${t}</span>`).join('')}
                        </div>
                        <button onclick='addFromDiscovery(${JSON.stringify(item).replace(/'/g, "&apos;")})' class="bg-white text-gray-900 p-2.5 rounded-2xl shadow-sm border border-gray-100 tap-scale">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function addFromDiscovery(item) {
            await saveToFirestore(item);
            showToast(`Added: ${item.name}`);
        }

        async function processWithAI() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if (!text) return;
            toggleLoading(true);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: `å›å‚³ JSON: {"name": "...", "city": "ç²¾ç¢ºç¸£å¸‚", "category": "...", "rating": 4.5, "tags": ["..."], "summary": "..."}` }] },
                        tools: [{ "google_search": {} }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const result = await response.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                await saveToFirestore(data);
                input.value = "";
                showToast(`Saved to ${data.city}`);
            } catch (err) {
                showToast("Analysis Error");
            } finally {
                toggleLoading(false);
            }
        }

        async function processImageWithAI(event) {
            const file = event.target.files[0];
            if (!file) return;
            toggleLoading(true);
            try {
                const base64Data = await fileToBase64(file);
                const base64Content = base64Data.split(',')[1];
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "è¾¨è­˜åº—å®¶" }, { inlineData: { mimeType: file.type, data: base64Content } }] }],
                        systemInstruction: { parts: [{ text: `å›å‚³ JSON: {"name": "...", "city": "ç²¾ç¢ºç¸£å¸‚", "category": "...", "rating": 4.5, "tags": ["..."], "summary": "..."}` }] },
                        tools: [{ "google_search": {} }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const result = await response.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                await saveToFirestore(data);
                showToast(`Vision Saved: ${data.name}`);
            } catch (err) {
                showToast("Vision Error");
            } finally {
                toggleLoading(false);
                event.target.value = '';
            }
        }

        function updateMapData() {
            const citiesWithStores = [...new Set(allRestaurants.map(r => r.city))];
            const paths = document.querySelectorAll('#taiwan-map path');
            paths.forEach(path => {
                path.classList.remove('has-store', 'active-city');
                if (citiesWithStores.includes(path.id)) path.classList.add('has-store');
                if (currentCityFilter === path.id) path.classList.add('active-city');
            });
            document.getElementById('stat-count').innerText = allRestaurants.length;
            document.getElementById('stat-city').innerText = citiesWithStores.length;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-orange-500', 'text-gray-300'));
            document.getElementById(`tab-${tabId}`).classList.replace('text-gray-300', 'text-orange-500');
            document.getElementById('main-header').style.display = (tabId === 'home') ? 'block' : 'none';
        }

        async function saveToFirestore(data) {
            const { db, auth, appId, collection, doc, setDoc } = window.dbTools;
            const uid = auth.currentUser.uid;
            const newDocRef = doc(collection(db, 'artifacts', appId, 'users', uid, 'restaurants'));
            await setDoc(newDocRef, { ...data, createdAt: Date.now() });
        }

        function updateUI() {
            const grid = document.getElementById('restaurant-grid');
            const empty = document.getElementById('empty-state');
            const filtered = currentCityFilter === "å…¨éƒ¨" ? allRestaurants : allRestaurants.filter(r => r.city === currentCityFilter);

            const cityTabs = document.getElementById('city-tabs');
            const cities = [...new Set(allRestaurants.map(r => r.city))];
            cityTabs.innerHTML = `
                <button onclick="filterByCity('å…¨éƒ¨')" class="city-tab-item relative whitespace-nowrap text-[10px] font-black uppercase tracking-widest ${currentCityFilter === 'å…¨éƒ¨' ? 'text-gray-900 tab-active' : 'text-gray-400'} pb-1">All Stores</button>
                ${cities.map(city => `
                    <button onclick="filterByCity('${city}')" class="city-tab-item relative whitespace-nowrap text-[10px] font-black uppercase tracking-widest ${currentCityFilter === city ? 'text-gray-900 tab-active' : 'text-gray-400'} pb-1">${city}</button>
                `).join('')}
            `;

            if (filtered.length === 0) {
                grid.innerHTML = "";
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                grid.innerHTML = filtered.map(res => `
                    <div class="bg-white/80 rounded-[3rem] overflow-hidden card-shadow border border-white tap-scale transition-all">
                        <div class="relative h-48 bg-gradient-to-br from-orange-50 to-orange-100 flex items-center justify-center">
                            <span class="text-6xl filter drop-shadow-2xl">${getEmoji(res.category)}</span>
                            <div class="absolute top-6 left-6 bg-white/90 backdrop-blur-md px-3 py-1 rounded-full text-[9px] font-black text-gray-900 border border-white uppercase tracking-tighter">${res.city}</div>
                            <button onclick="removeRestaurant('${res.id}')" class="absolute top-6 right-6 bg-white/20 p-2.5 rounded-2xl text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                        <div class="p-8">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-black text-gray-900 leading-tight">${res.name}</h3>
                                <div class="flex items-center gap-1 text-orange-500 font-black text-sm">
                                    <i data-lucide="star" class="w-4 h-4 fill-orange-500"></i> ${res.rating}
                                </div>
                            </div>
                            <div class="text-[10px] font-black text-orange-600 mb-4 uppercase tracking-[0.1em]">${res.category}</div>
                            <p class="text-xs text-gray-500 leading-relaxed font-medium mb-6 line-clamp-2">${res.summary}</p>
                            <div class="flex gap-2">
                                ${res.tags.slice(0,2).map(t => `<span class="bg-gray-50 text-gray-400 text-[9px] px-3 py-1.5 rounded-xl font-black">#${t}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        async function removeRestaurant(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤æ”¶è—ï¼Ÿ")) return;
            const { db, auth, appId, doc, deleteDoc } = window.dbTools;
            const uid = auth.currentUser.uid;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', uid, 'restaurants', id));
        }

        function filterByCity(name) {
            currentCityFilter = name;
            updateUI();
            updateMapData();
        }

        function getEmoji(cat) {
            const map = { "ç‡’è‚‰": "ğŸ”¥", "å’–å•¡å»³": "â˜•", "æ—¥å¼": "ğŸ£", "ç”œé»": "ğŸ°", "ç¾©å¼": "ğŸ", "ä¸­å¼": "ğŸ¥Ÿ", "ç«é‹": "ğŸ²", "éŸ“å¼": "ğŸ‡°ğŸ‡·", "æ—©åˆé¤": "ğŸ³", "å°å¼": "ğŸš", "è·¯é‚Šæ”¤": "ğŸ¢" };
            return map[cat] || "ğŸ´";
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('bottom-36');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'pointer-events-none');
                toast.classList.remove('bottom-36');
            }, 3000);
        }

        function triggerImageUpload() { document.getElementById('imageInput').click(); }
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = e => reject(e); }); }
        function toggleLoading(show) { document.getElementById('loading-skeleton').classList.toggle('hidden', !show); document.getElementById('restaurant-grid').classList.toggle('opacity-20', show); }

        init();
    </script>
</body>
</html>